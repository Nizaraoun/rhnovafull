<div class="projects-container">
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1>My Projects</h1>
        <p class="header-subtitle">Manage and track your project portfolio</p>
      </div>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <i class="fas fa-plus"></i>
        <span>New Project</span>
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-project-diagram"></i>
      </div>
      <div class="stat-content">
        <h3>{{ projects.length }}</h3>
        <p>Total Projects</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-play-circle"></i>
      </div>
      <div class="stat-content">
        <h3>{{ getProjectCount('EN_COURS') }}</h3>
        <p>In Progress</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <h3>{{ getProjectCount('TERMINE') }}</h3>
        <p>Completed</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-dollar-sign"></i>
      </div>
      <div class="stat-content">
        <h3>{{ getTotalBudget() | currency:'EUR':'symbol':'1.0-0' }}</h3>
        <p>Total Budget</p>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="search-box">
      <input 
        type="text" 
        placeholder="Search projects..." 
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilters()"
      />
      <i class="fas fa-search"></i>
    </div>
    
    <select [(ngModel)]="statusFilter" (ngModelChange)="applyFilters()">
      <option value="all">All Status</option>
      <option value="EN_ATTENTE">Pending</option>
      <option value="PLANIFIE">Planned</option>
      <option value="EN_COURS">In Progress</option>
      <option value="TERMINE">Completed</option>
      <option value="ANNULE">Cancelled</option>
    </select>
  </div>

  <!-- Projects List -->
  <div class="projects-grid" *ngIf="!isLoading">
    <div class="project-card enhanced-project-card" *ngFor="let project of filteredProjects">
      <div class="card-header">
        <div class="project-title-row">
          <h3>{{ project.nom }}</h3>
          <span class="status-badge" [class]="'status-' + project.statut.toLowerCase().replace('_', '-')">
            <i class="fas fa-circle"></i>
            {{ getStatusText(project.statut) }}
          </span>
        </div>
        <div class="project-meta">
          <div class="meta-item">
            <i class="fas fa-calendar"></i>
            <span>{{ project.dateFin | date:'MMM dd, yyyy' }}</span>
          </div>
          <div class="meta-item" *ngIf="project.equipeNom">
            <i class="fas fa-users"></i>
            <span>{{ project.equipeNom }}</span>
          </div>
        </div>
      </div>

      <div class="card-body">
        <p class="project-description">{{ project.description }}</p>
        
        <div class="project-info-grid">
          <div class="info-item">
            <span class="label">Budget</span>
            <span class="value">{{ project.budget | currency:'EUR':'symbol':'1.0-0' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Team</span>
            <span class="value" [class]="{'team-name': project.equipeNom}">{{ project.equipeNom || 'Not assigned' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Tasks</span>
            <span class="value">{{ project.nombreTaches || 0 }} total</span>
          </div>
          <div class="info-item">
            <span class="label">Due Date</span>
            <span class="value" [class]="{ 'overdue': isOverdue(project) }">
              {{ project.dateFin | date:'short' }}
              <span *ngIf="isOverdue(project)" class="overdue-badge">OVERDUE</span>
            </span>
          </div>
        </div>
        
        <div class="project-progress">
          <div class="progress-header">
            <span>Progress: {{ project.progression }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="project.progression"></div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" (click)="openCreateTaskModal(project)" title="Add Task">
            <i class="fas fa-plus"></i>
            <span>Add Task</span>
          </button>
          <button class="btn btn-secondary" (click)="openProjectTasksModal(project)" title="View Tasks">
            <i class="fas fa-tasks"></i>
            <span>Tasks</span>
          </button>
          <button class="btn btn-secondary" (click)="openAssignTeamModal(project)" title="Assign Team">
            <i class="fas fa-users"></i>
            <span>Team</span>
          </button>
          <button class="btn btn-warning" (click)="openEditModal(project)" title="Edit">
            <i class="fas fa-edit"></i>
            <span>Edit</span>
          </button>
          <button class="btn btn-danger" (click)="deleteProject(project.id)" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading projects...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && filteredProjects.length === 0" class="empty-state">
    <i class="fas fa-project-diagram"></i>
    <h3>No projects found</h3>
    <p>Start by creating your first project.</p>
    <button class="btn btn-primary" (click)="openCreateModal()">Create Project</button>
  </div>
</div>

<!-- Create Project Modal -->
<div class="modal enhanced-modal" [class.show]="showCreateModal" *ngIf="showCreateModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-plus-circle"></i>
        <span>Create New Project</span>
      </div>
      <button class="btn-close" (click)="closeCreateModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="projectForm" (ngSubmit)="createProject()">
      <div class="modal-body">
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-info-circle"></i>
            Project Information
          </h4>
          
          <div class="form-group">
            <label for="nom">Project Name *</label>
            <input 
              type="text" 
              id="nom" 
              formControlName="nom" 
              placeholder="Enter project name"
              class="form-control"
            />
            <div class="error" *ngIf="projectForm.get('nom')?.touched && projectForm.get('nom')?.errors">
              <div *ngIf="projectForm.get('nom')?.errors?.['required']">Project name is required</div>
              <div *ngIf="projectForm.get('nom')?.errors?.['minlength']">Project name must be at least 3 characters</div>
              <div *ngIf="projectForm.get('nom')?.errors?.['maxlength']">Project name cannot exceed 100 characters</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="description">Description *</label>
            <textarea 
              id="description" 
              formControlName="description" 
              rows="4"
              placeholder="Enter project description"
              class="form-control"
            ></textarea>
            <div class="error" *ngIf="projectForm.get('description')?.touched && projectForm.get('description')?.errors">
              <div *ngIf="projectForm.get('description')?.errors?.['required']">Description is required</div>
              <div *ngIf="projectForm.get('description')?.errors?.['minlength']">Description must be at least 10 characters</div>
              <div *ngIf="projectForm.get('description')?.errors?.['maxlength']">Description cannot exceed 500 characters</div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="dateDebut">Start Date *</label>
              <input type="date" id="dateDebut" formControlName="dateDebut" class="form-control" />
            </div>
            <div class="form-group">
              <label for="dateFin">End Date *</label>
              <input type="date" id="dateFin" formControlName="dateFin" class="form-control" />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="budget">Budget (TND) *</label>
              <input type="number" id="budget" formControlName="budget" min="0" step="100" class="form-control" placeholder="0" />
            </div>
            <div class="form-group">
              <label for="statut">Status</label>
              <select id="statut" formControlName="statut" class="form-control">
                <option value="EN_ATTENTE">Pending</option>
                <option value="PLANIFIE">Planned</option>
                <option value="EN_COURS">In Progress</option>
                <option value="TERMINE">Completed</option>
                <option value="ANNULE">Cancelled</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">
          <i class="fas fa-times"></i>
          <span>Cancel</span>
        </button>
        <button type="submit" class="btn btn-success" [disabled]="!projectForm.valid">
          <i class="fas fa-check"></i>
          <span>Create Project</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Project Modal -->
<div class="modal enhanced-modal" [class.show]="showEditModal" *ngIf="showEditModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-edit"></i>
        <span>Edit Project</span>
      </div>
      <button class="btn-close" (click)="closeEditModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="projectForm" (ngSubmit)="updateProject()">
      <div class="modal-body">
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-info-circle"></i>
            Project Information
          </h4>
          
          <div class="form-group">
            <label for="edit-nom">Project Name *</label>
            <input 
              type="text" 
              id="edit-nom" 
              formControlName="nom" 
              placeholder="Enter project name"
              class="form-control"
            />
            <div class="error" *ngIf="projectForm.get('nom')?.touched && projectForm.get('nom')?.errors">
              <div *ngIf="projectForm.get('nom')?.errors?.['required']">Project name is required</div>
              <div *ngIf="projectForm.get('nom')?.errors?.['minlength']">Project name must be at least 3 characters</div>
              <div *ngIf="projectForm.get('nom')?.errors?.['maxlength']">Project name cannot exceed 100 characters</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="edit-description">Description *</label>
            <textarea 
              id="edit-description" 
              formControlName="description" 
              rows="4"
              placeholder="Enter project description"
              class="form-control"
            ></textarea>
            <div class="error" *ngIf="projectForm.get('description')?.touched && projectForm.get('description')?.errors">
              <div *ngIf="projectForm.get('description')?.errors?.['required']">Description is required</div>
              <div *ngIf="projectForm.get('description')?.errors?.['minlength']">Description must be at least 10 characters</div>
              <div *ngIf="projectForm.get('description')?.errors?.['maxlength']">Description cannot exceed 500 characters</div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="edit-dateDebut">Start Date *</label>
              <input type="date" id="edit-dateDebut" formControlName="dateDebut" class="form-control" />
            </div>
            <div class="form-group">
              <label for="edit-dateFin">End Date *</label>
              <input type="date" id="edit-dateFin" formControlName="dateFin" class="form-control" />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="edit-budget">Budget (TND) *</label>
              <input type="number" id="edit-budget" formControlName="budget" min="0" step="100" class="form-control" />
            </div>
            <div class="form-group">
              <label for="edit-statut">Status</label>
              <select id="edit-statut" formControlName="statut" class="form-control">
                <option value="EN_ATTENTE">Pending</option>
                <option value="PLANIFIE">Planned</option>
                <option value="EN_COURS">In Progress</option>
                <option value="TERMINE">Completed</option>
                <option value="ANNULE">Cancelled</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
          <i class="fas fa-times"></i>
          <span>Cancel</span>
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!projectForm.valid">
          <i class="fas fa-save"></i>
          <span>Update Project</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Assign Team Modal -->
<div class="modal enhanced-modal" [class.show]="showAssignTeamModal" *ngIf="showAssignTeamModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-users"></i>
        <span>Assign Team to Project</span>
      </div>
      <button class="btn-close" (click)="closeAssignTeamModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="form-section">
        <h4 class="section-title">
          <i class="fas fa-project-diagram"></i>
          Project: {{ selectedProject?.nom }}
        </h4>
        
        <div *ngIf="teamDetails" class="team-card">
          <div class="team-header">
            <div class="team-info">
              <h4>{{ teamDetails.nom }}</h4>
              <div class="team-stats">
                <span class="stat-item">
                  <i class="fas fa-users"></i>
                  {{ teamDetails.nombreMembres || teamDetails.membres.length || 0 }} members
                </span>
              </div>
            </div>
          </div>
          
          <div class="team-description" *ngIf="teamDetails.description">
            <p>{{ teamDetails.description }}</p>
          </div>
          
          <div class="members-section" *ngIf="teamDetails.membres && teamDetails.membres.length > 0">
            <h5 class="members-title">
              <i class="fas fa-user-friends"></i>
              Team Members
            </h5>
            <div class="members-grid">
              <div class="member-card" *ngFor="let member of teamDetails.membres">
                <div class="member-avatar">
                  <i class="fas fa-user-circle"></i>
                </div>
                <div class="member-info">
                  <span class="member-name">{{ member.name }}</span>
                  <small class="member-role">{{ member.role }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div *ngIf="!teamDetails" class="empty-team-state">
          <div class="empty-icon">
            <i class="fas fa-users-slash"></i>
          </div>
          <h4>No Team Found</h4>
          <p>You don't have a team assigned to your account. Please contact your administrator to assign a team before you can assign it to projects.</p>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeAssignTeamModal()">
        <i class="fas fa-times"></i>
        <span>Cancel</span>
      </button>
      <button 
        type="button" 
        class="btn btn-success" 
        (click)="assignTeamToProject()"
        [disabled]="!teamDetails || !selectedProject"
      >
        <i class="fas fa-check"></i>
        <span>Assign Team</span>
      </button>
    </div>
  </div>
</div>

<!-- Create Task Modal -->
<div class="modal enhanced-modal" [class.show]="showCreateTaskModal" *ngIf="showCreateTaskModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-plus-circle"></i>
        <span>Create Task in {{ selectedProject?.nom }}</span>
      </div>
      <button class="btn-close" (click)="closeCreateTaskModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="taskForm" (ngSubmit)="createTaskInProject()">
      <div class="modal-body">
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-tasks"></i>
            Task Information
          </h4>
          
          <div class="form-group">
            <label for="task-title">Task Title *</label>
            <input 
              type="text" 
              id="task-title" 
              formControlName="titre" 
              placeholder="Enter task title"
              class="form-control"
            />
            <div class="error" *ngIf="taskForm.get('titre')?.touched && taskForm.get('titre')?.errors">
              <div *ngIf="taskForm.get('titre')?.errors?.['required']">Task title is required</div>
              <div *ngIf="taskForm.get('titre')?.errors?.['minlength']">Task title must be at least 3 characters</div>
              <div *ngIf="taskForm.get('titre')?.errors?.['maxlength']">Task title cannot exceed 100 characters</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="task-description">Description *</label>
            <textarea 
              id="task-description" 
              formControlName="description" 
              placeholder="Enter task description"
              class="form-control"
              rows="4"
            ></textarea>
            <div class="error" *ngIf="taskForm.get('description')?.touched && taskForm.get('description')?.errors">
              <div *ngIf="taskForm.get('description')?.errors?.['required']">Task description is required</div>
              <div *ngIf="taskForm.get('description')?.errors?.['minlength']">Description must be at least 10 characters</div>
              <div *ngIf="taskForm.get('description')?.errors?.['maxlength']">Description cannot exceed 500 characters</div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="task-dateDebut">Start Date *</label>
              <input 
                type="date" 
                id="task-dateDebut" 
                formControlName="dateDebut" 
                class="form-control"
              />
            </div>
            <div class="form-group">
              <label for="task-dateFin">End Date *</label>
              <input 
                type="date" 
                id="task-dateFin" 
                formControlName="dateFin" 
                class="form-control"
              />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="task-priorite">Priority</label>
              <select id="task-priorite" formControlName="priorite" class="form-control">
                <option value="BASSE">Low</option>
                <option value="MOYENNE">Medium</option>
                <option value="HAUTE">High</option>
              </select>
            </div>
            <div class="form-group">
              <label for="task-assignee">Assign to</label>
              <select id="task-assignee" formControlName="assigneeId" class="form-control">
                <option value="">Select team member</option>
                <option *ngFor="let member of teamMembers" [value]="member.id">
                  {{ member.name }} ({{ member.role }})
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCreateTaskModal()">
          <i class="fas fa-times"></i>
          <span>Cancel</span>
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!taskForm.valid">
          <i class="fas fa-check"></i>
          <span>Create Task</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Project Tasks Modal -->
<div class="modal enhanced-modal" [class.show]="showProjectTasksModal" *ngIf="showProjectTasksModal">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-tasks"></i>
        <span>Tasks for {{ selectedProject?.nom }}</span>
      </div>
      <button class="btn-close" (click)="closeProjectTasksModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div *ngIf="isLoadingTasks" class="loading-container">
        <div class="spinner"></div>
        <p>Loading tasks...</p>
      </div>
      
      <div *ngIf="!isLoadingTasks && selectedProjectTasks.length > 0" class="tasks-list">
        <div class="task-card" *ngFor="let task of selectedProjectTasks">
          <div class="task-header">
            <div class="task-title-section">
              <h4>{{ task.titre }}</h4>
              <div class="task-badges">
                <span class="status-badge" [class]="'status-' + task.statut.toLowerCase().replace('_', '-')">
                  <i class="fas fa-circle"></i>
                  {{ getTaskStatusText(task.statut) }}
                </span>
                <span class="priority-badge" [class]="'priority-' + task.priorite.toLowerCase()">
                  <i class="fas fa-flag"></i>
                  {{ getTaskPriorityText(task.priorite) }}
                </span>
              </div>
            </div>
          </div>
          
          <p class="task-description">{{ task.description }}</p>
          
          <div class="task-meta-grid">
            <div class="meta-item">
              <i class="fas fa-user"></i>
              <div class="meta-content">
                <span class="meta-label">Assigned to</span>
                <span class="meta-value">{{ task.membreName || 'Unassigned' }}</span>
              </div>
            </div>
            <div class="meta-item">
              <i class="fas fa-calendar-check"></i>
              <div class="meta-content">
                <span class="meta-label">Due Date</span>
                <span class="meta-value">{{ task.dateFin | date:'MMM dd, yyyy' }}</span>
              </div>
            </div>
            <div class="meta-item">
              <i class="fas fa-chart-line"></i>
              <div class="meta-content">
                <span class="meta-label">Progress</span>
                <span class="meta-value">{{ task.progression || 0 }}%</span>
              </div>
            </div>
          </div>
          
          <div class="task-progress" *ngIf="task.statut !== 'TERMINEE'">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="task.progression || 0"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="!isLoadingTasks && selectedProjectTasks.length === 0" class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-tasks"></i>
        </div>
        <h4>No Tasks Found</h4>
        <p>This project doesn't have any tasks yet. Create the first task to get started.</p>
        <button class="btn btn-primary" (click)="openCreateTaskModal(selectedProject!)">
          <i class="fas fa-plus"></i>
          <span>Create First Task</span>
        </button>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeProjectTasksModal()">
        <i class="fas fa-times"></i>
        <span>Close</span>
      </button>
      <button type="button" class="btn btn-primary" (click)="openCreateTaskModal(selectedProject!)">
        <i class="fas fa-plus"></i>
        <span>Add New Task</span>
      </button>
    </div>
  </div>
</div>
